--- 
layout: post
tags: []

type: post
meta: 
  _encloseme: "1"
published: true
title: javascript必知必会之this关键字及scope

status: publish
category: tech
---
<span style="font-family: Sans; line-height: normal; font-size: medium; ">
<h1 class="title" style="text-align: center; ">javascript必知必会之this关键字及scope</h1>
<p>本博客所有内容采用&nbsp;<a class="reference external" href="http://creativecommons.org/about/licenses/meet-the-licenses">Creative Commons Licenses</a>&nbsp;许可使用. 引用本内容时，请保留&nbsp;<a class="reference external" href="http://sites.google.com/site/towerjoo">朱涛</a>,&nbsp;<a class="reference external" href="http://www.cnblogs.com/mindsbook">出处</a>&nbsp;，并且&nbsp;<strong>非商业</strong>&nbsp;.</p>
<p>点击&nbsp;<a class="reference external" href="http://feed.feedsky.com/MindsbookTowerJoo">订阅</a>&nbsp;来订阅本博客.(推荐使用&nbsp;<a class="reference external" href="http://reader.google.com/">google reader</a>, 如果你的浏览器不支持直接订阅,请直接在&nbsp;<a class="reference external" href="http://reader.google.com/">google reader</a>&nbsp;中手动添加).</p>
<p>下面的代码片断缩进目前还不完善,你也可以选择&nbsp;<a class="reference external" href="http://sites.google.com/site/towerjoo/download/javascript%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A%E4%B9%8Bthis%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8Ascope.pdf?attredirects=0">下载pdf</a>&nbsp;来阅读.</p>
<div class="section" id="id1">
<h1><a class="toc-backref" href="#id15" style="text-decoration: none; color: black; ">摘要</a></h1>
<p>本系列博文主要谈一些在&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;使用中经常会混淆的高级应用,包括:&nbsp;<a class="reference external" href="http://www.cnblogs.com/mindsbook/archive/2009/09/19/javascriptYouMustKnowPrototype.html">prototype</a>,&nbsp;<a class="reference external" href="http://www.cnblogs.com/mindsbook/archive/2009/09/21/javascriptYouMustKnowClosure.html">closure</a>, scope, this关键字. 对于一个需要提高自己javascript水平的程序员,这些都是必须要掌握的.</p>
<p>本节主要介绍this关键字和scope.</p>
<p>本文的javascript源代码从&nbsp;<a class="reference external" href="http://sites.google.com/site/towerjoo/download/this.html?attredirects=0">这儿</a>&nbsp;下载.</p>
<div class="contents topic" id="contents" style="margin-top: 2em; margin-right: 2em; margin-bottom: 2em; margin-left: 2em; ">
<p class="topic-title first" style="margin-top: 0px !important; font-weight: bold; ">Contents</p>
<ul class="simple" style="margin-bottom: 1em; ">
    <li><a class="reference internal" href="#id1" id="id15">摘要</a></li>
    <li><a class="reference internal" href="#id3" id="id16">引入</a></li>
    <li><a class="reference internal" href="#this" id="id17">this关键字</a></li>
    <li><a class="reference internal" href="#apply-call" id="id18">关于apply和call</a></li>
    <li><a class="reference internal" href="#scope" id="id19">scope详述</a></li>
    <li><a class="reference internal" href="#id4" id="id20">一些说明</a></li>
    <li><a class="reference internal" href="#id5" id="id21">结论</a></li>
    <li><a class="reference internal" href="#id6" id="id22">后记</a></li>
    <li><a class="reference internal" href="#id7" id="id23">参考资料</a></li>
    <li><a class="reference internal" href="#id8" id="id24">本文的源码</a></li>
</ul>
</div>
</div>
<div class="section" id="id3">
<h1><a class="toc-backref" href="#id16" style="text-decoration: none; color: black; ">引入</a></h1>
<p>作为一个程序员, 你可能早已经习惯于面向对象语言中指代当前对象的引用(或者指针), 如的c++中的this或者&nbsp;<a class="reference external" href="http://python.org/">python</a>&nbsp;中的self,当然具有OO属性(&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;其实更多的是一种所谓的函数式语言)的&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;同样, 它也具有引用当前属性的对象的指针(或者引用), 也就是this关键字.</p>
<p>为了理解this关键字,如果你只想记住一句话,那应该是&nbsp;<strong>this关键字总是指向当前函数的所有者对象(执行空间)</strong>, 至于这句话如何理解, 可以参见下面的详细说明.</p>
<p>那么什么是&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Scope_(programming)">scope</a>&nbsp;呢?</p>
<p><a class="reference external" href="http://wikipedia.org/">wikipedia</a>&nbsp;中的解释是&nbsp;<em>In computer programming, scope is an enclosing context where values and expressions are associated.</em>&nbsp;中文即是所谓的&nbsp;<strong>作用域</strong>, 它指明的是一个数值或者表达式所关联的上下文(能够被引用的执行空间).</p>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Scope_(programming)">scope</a>&nbsp;与this有什么关系呢? 如果从上面的定义来看, this指向的总是当前引用此函数的对象,而当你要判断当前引用的对象时, 这时你就得弄清楚当前函数所在的&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Scope_(programming)">scope</a>. 具体可见下面的分析.</p>
</div>
<div class="section" id="this">
<h1><a class="toc-backref" href="#id17" style="text-decoration: none; color: black; ">this关键字</a></h1>
<p>请看下面的几个例子.</p>
<p>一个&nbsp;<a class="reference external" href="http://python.org/">python</a>&nbsp;的例子:</p>
<div class="highlight">
<pre><span style="color: #008000; font-weight: bold; ">class</span> <span style="color: #0000ff; font-weight: bold; ">Person</span>(<span style="color: #008000; ">object</span>):
<span style="color: #ba2121; font-style: italic; ">"""a person class</span>
<span style="color: #ba2121; font-style: italic; ">    """</span>
<span style="color: #008000; font-weight: bold; ">def</span> <span style="color: #0000ff; ">__init__</span>(<span style="color: #008000; ">self</span>, name):
<span style="color: #008000; ">self</span><span style="color: #666666; ">.</span>name <span style="color: #666666; ">=</span> name    <span style="color: #408080; font-style: italic; ">#这里的self指向的是实例化后的对象,如下面中的zhutao</span>
<span style="color: #008000; font-weight: bold; ">def</span> <span style="color: #0000ff; ">get_name</span>(<span style="color: #008000; ">self</span>):
<span style="color: #008000; font-weight: bold; ">return</span> <span style="color: #008000; ">self</span><span style="color: #666666; ">.</span>name
zhutao <span style="color: #666666; ">=</span> Person(<span style="color: #ba2121; ">"zhutao"</span>)
<span style="color: #008000; font-weight: bold; ">print</span> zhutao<span style="color: #666666; ">.</span>name
</pre>
</div>
<p>一个&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;的例子:</p>
<div class="highlight">
<pre><span style="color: #008000; ">window</span>.name <span style="color: #666666; ">=</span> <span style="color: #ba2121; ">"zhutao from window"</span>
<span style="color: #008000; font-weight: bold; ">var</span> get_name <span style="color: #666666; ">=</span> <span style="color: #008000; font-weight: bold; ">function</span>(){
<span style="color: #008000; font-weight: bold; ">return</span> <span style="color: #008000; font-weight: bold; ">this</span>.name<span style="color: #666666; ">;</span>   <span style="color: #408080; font-style: italic; ">// this的具体指向只能在运行时才能确定,也就是确定运行时调用其的对象</span>
};
alert(get_name());  <span style="color: #408080; font-style: italic; ">// 输出zhutao from window, get_name调用的对象为window</span>
<span style="color: #008000; font-weight: bold; ">var</span> obj <span style="color: #666666; ">=</span> {}
obj.name <span style="color: #666666; ">=</span> <span style="color: #ba2121; ">"zhutao from obj"</span><span style="color: #666666; ">;</span>
alert(get_name.apply(obj)); <span style="color: #408080; font-style: italic; ">// 输出zhutao from obj, 我们强制地使用了 apply来更改调用的对象,使其指向obj</span>
<span style="color: #008000; font-weight: bold; ">var</span> innerobj <span style="color: #666666; ">=</span> {
<span style="color: #ba2121; ">"name"</span> <span style="color: #666666; ">:</span> <span style="color: #ba2121; ">"zhutao from innerobj"</span>
};
innerobj.get_name <span style="color: #666666; ">=</span> get_name<span style="color: #666666; ">;</span>   <span style="color: #408080; font-style: italic; ">// 使得innerobj的get_name方法指向了global scope的get_name函数</span>
alert(innerobj.get_name()); <span style="color: #408080; font-style: italic; ">// 输出zhutao from innerobj, 此时this指向的是innerobj</span>
</pre>
</div>
<p>那么从上面的简单例子来看,&nbsp;<strong>this</strong>&nbsp;总是在&nbsp;<strong>运行时</strong>&nbsp;才能确定其具体的指向, 也才能知道它的调用对象.而 这点也正是&nbsp;<strong>动态语言</strong>&nbsp;一个重要特性.</p>
<p>那么如何确定当前this指向的引用对象呢? 通常可以这样判断:</p>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li>如果在global的scope(可以参见下面的说明来明确什么是global scope)来调用,则指向的是bowser的顶级对象window 例如:&nbsp;<cite>get_name()</cite></li>
    <li>如果, 有类似于这样的引用,&nbsp;<cite>innerobj.get_name()</cite>&nbsp;则很显然this指向的是innerobj</li>
    <li>如果我们使用了apply, call来进行强制的引用对象指向, 则也会很显然地指向强制的对象,如&nbsp;<cite>get_name.apply(obj)</cite>.</li>
</ol>
</div>
<div class="section" id="apply-call">
<h1><a class="toc-backref" href="#id18" style="text-decoration: none; color: black; ">关于apply和call</a></h1>
<p>这2个关键字可以很简单地理解为&nbsp;<strong>进行this引用对象(运行空间)强制转换</strong>, 二者的语法如下:</p>
<ul class="simple" style="margin-bottom: 1em; ">
    <li>fun.call(object, arg1, arg2, ...)</li>
    <li>fun.apply(object, [arg1, arg2, ...])</li>
</ul>
<p>二者目的是相同的(动态更改函数的运行空间, 或者称作更改this指向的对象), 只是在提供给函数的参数上的调用方法不同.</p>
<p>示例代码如下:</p>
<div class="highlight">
<pre><span style="color: #008000; font-weight: bold; ">var</span> test_call_apply <span style="color: #666666; ">=</span> <span style="color: #008000; font-weight: bold; ">function</span>(name<span style="color: #666666; ">,</span> gender<span style="color: #666666; ">,</span> school){
alert(<span style="color: #008000; font-weight: bold; ">this</span>.age <span style="color: #666666; ">+</span> name <span style="color: #666666; ">+</span> gender <span style="color: #666666; ">+</span> school);
};
test_call_apply.call({age<span style="color: #666666; ">:24</span>}<span style="color: #666666; ">,</span> <span style="color: #ba2121; ">"zhutao"</span><span style="color: #666666; ">,</span> <span style="color: #ba2121; ">"male"</span><span style="color: #666666; ">,</span> <span style="color: #ba2121; ">"ISCAS"</span>);
test_call_apply.apply({age<span style="color: #666666; ">:24</span>}<span style="color: #666666; ">,</span> [<span style="color: #ba2121; ">"zhutao"</span><span style="color: #666666; ">,</span> <span style="color: #ba2121; ">"male"</span><span style="color: #666666; ">,</span> <span style="color: #ba2121; ">"ISCAS"</span>]);
</pre>
</div>
</div>
<div class="section" id="scope">
<h1><a class="toc-backref" href="#id19" style="text-decoration: none; color: black; ">scope详述</a></h1>
<p>先看下面几个例子:</p>
<div class="highlight">
<pre><span style="color: #008000; font-weight: bold; ">var</span> global_scope <span style="color: #666666; ">=</span> <span style="color: #ba2121; ">"I'm global"</span><span style="color: #666666; ">;</span>
<span style="color: #008000; font-weight: bold; ">var</span> fun <span style="color: #666666; ">=</span> <span style="color: #008000; font-weight: bold; ">function</span>(){
<span style="color: #008000; font-weight: bold; ">var</span> fun_scope <span style="color: #666666; ">=</span> <span style="color: #ba2121; ">"I'm in fun scope"</span><span style="color: #666666; ">;</span>
<span style="color: #008000; font-weight: bold; ">return</span> innerfun(){
<span style="color: #008000; font-weight: bold; ">var</span> inner_func_scope <span style="color: #666666; ">=</span> <span style="color: #ba2121; ">"I'm in the inner fun scope"</span><span style="color: #666666; ">;</span>
<span style="color: #008000; font-weight: bold; ">return</span> global_scope <span style="color: #666666; ">+</span> fun_scope <span style="color: #666666; ">+</span> inner_func_scope<span style="color: #666666; ">;</span> <span style="color: #408080; font-style: italic; ">//此处的引用是重要的,请特别注意</span>
};
};
alert(fun()());
</pre>
</div>
<p>请注意上面的代码,其中:</p>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li>global_scope 它是global scope</li>
    <li>fun_scope 它是 位于一个函数的scope</li>
    <li>inner_func_scope 是一个位于一个函数内的函数的scope</li>
</ol>
<p>你也可以继续内嵌函数, 那么会生成若干个scope.</p>
<p>于是有个问题出现了, 为什么innerfun方法可以引用不在它自身scope的变量?</p>
<p>在回答这个问题之前,需要引入一个概念&nbsp;<strong>scope chain</strong>. 所谓的&nbsp;<strong>scope chain</strong>&nbsp;是指 在&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;的代码中形成的一个具有优先顺序, 相关的作用域的链.</p>
<p>以上面的代码为例,</p>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li>对于global的scope而言,它会为自己建立一个global的scope chain(当然此时,这个链只有一个scope).</li>
    <li>对于fun函数的scope而言, 它首先建立一个与global相同的scope chain,然后再加入自己的scope(此时,这个 链有2个scope), 类似于这样的结构: global==&gt;fun</li>
    <li>对于innerfun而言,除了fun函数所具有的链外,它还会加入自己的scope(当然,此时这个链有3个scope), 类似于这样的结构: global==&gt;fun==&gt;innerfun</li>
</ol>
<p>scope chain具有下面的特征:</p>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li>有序</li>
    <li>每当建立一个函数时,会自动生成一个scope并加入自己的scope chain中</li>
    <li>这个chain类似于一种栈,在查找变量时总是先从顶端查起</li>
</ol>
<p>参见下图:</p>
<img alt="http://farm4.static.flickr.com/3425/3958796284_615f096470_o.png" src="http://farm4.static.flickr.com/3425/3958796284_615f096470_o.png" />
<p>上图的3个部分对应上面代码中的三个变量的scope, 并且在对每个变量求值时,是按照 图中的scope chain从上到下依次查找,找到即返回值或者直到穷举了scope chain返回undfined.</p>
<p>那么现在回答上面那个问题:</p>
<p>其实也很好理解, 在计算某个表达式时, 它会对自己的scope chain进行从上到下的查找,如果找到了 它会立即返回这个值,如果找完了整个chain也没有找到,则返回undefined.</p>
<p>这个查找机制也就决定了,通常位于chain的前端的scope有更高的优先级.</p>
<p>例如&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;在计算&nbsp;<cite>global_scope + fun_scope + inner_func_scope;</cite>&nbsp;这个表达式时, 它会查找上面图示中的scope chain,从而确定出最后的结果.</p>
</div>
<div class="section" id="id4">
<h1><a class="toc-backref" href="#id20" style="text-decoration: none; color: black; ">一些说明</a></h1>
<p>如果你弄清楚了上面的论述, 应该说你对this关键字和scope已经具有完全的知识基础了,但是 我们需要在实际中更好地使用和理解这些概念,这样才能把能力上升到别一个层次, 这也即所谓的&nbsp;<strong>理论与实践</strong>&nbsp;的关系.</p>
<p>请看下面这个例子:</p>
<div class="highlight">
<pre><span style="color: #008000; font-weight: bold; ">var</span> change_color <span style="color: #666666; ">=</span> <span style="color: #008000; font-weight: bold; ">function</span>(){
<span style="color: #008000; font-weight: bold; ">this</span>.style.color <span style="color: #666666; ">=</span> <span style="color: #ba2121; ">"red"</span><span style="color: #666666; ">;</span>
};
<span style="color: #008000; ">window</span>.onload <span style="color: #666666; ">=</span> <span style="color: #008000; font-weight: bold; ">function</span>(){
<span style="color: #008000; font-weight: bold; ">var</span> text <span style="color: #666666; ">=</span> <span style="color: #008000; ">document</span>.getElementById(<span style="color: #ba2121; ">"text"</span>);
text.onclick <span style="color: #666666; ">=</span> change_color<span style="color: #666666; ">;</span>    <span style="color: #408080; font-style: italic; ">//此时this指向的是text这个对象(dom对象)</span>
};
<span style="color: #408080; font-style: italic; ">// 下面这行代码是在body中</span>
<span style="color: #666666; ">&lt;</span>span id<span style="color: #666666; ">=</span><span style="color: #ba2121; ">"another"</span> onclick<span style="color: #666666; ">=</span><span style="color: #ba2121; ">"change_color()"</span><span style="color: #666666; ">&gt;</span>My color will be changed2.<span style="color: #666666; ">&lt;/</span>span<span style="color: #666666; ">&gt;</span> <span style="color: #408080; font-style: italic; ">//这点需要特别注意, inline script指向的是window,此处会无定义</span>
</pre>
</div>
<p>需要特别注意的是:</p>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li>inline event registration中的this并非指向的是自己的dom节点,而是global scope的window,这点可以从上面的例子中得到证明</li>
    <li>这种inline event registration是不可取的, 推荐的是&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Unobtrusive_JavaScript">Unobtrusive JavaScript</a>&nbsp;(处理逻辑和页面结构相分离)</li>
</ol>
</div>
<div class="section" id="id5">
<h1><a class="toc-backref" href="#id21" style="text-decoration: none; color: black; ">结论</a></h1>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;是一种非常强大的动态语言, 它是&nbsp;<strong>披着C语言外衣的函数式语言</strong>, 如果你只当作它是一种 类C的命令式语言,那么你的知识层次还过于低, 而倘若你能够理解到<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;的函数式语言本质, 你在运用&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;,理解&nbsp;<a class="reference external" href="http://jquery.com/">jQuery</a>&nbsp;及其它的库, 甚至自己写一些&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;都会游刃有余的.</p>
</div>
<div class="section" id="id6">
<h1><a class="toc-backref" href="#id22" style="text-decoration: none; color: black; ">后记</a></h1>
<p>本系列的计划的内容已经结束,除了这些而外, 我还想写一至二篇补遗的&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;的高级知识来作为本系列的终结. 可能会写的内容包括:</p>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li><a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;函数式语言特征探究</li>
    <li><a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">javascript</a>&nbsp;相关库的分析</li>
    <li><em>Unobtrusive JavaScript</em>&nbsp;的一些理解和实践</li>
</ol>
<p>总之,&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a>&nbsp;本身是很值得探究的一个语言, 也有很多的值得一书的地方, 我希望后续能够不断地完成这个计划.</p>
<p>其实,之前写过&nbsp;<a class="reference external" href="http://www.cnblogs.com/mindsbook/archive/2009/08/17/DjangoMustKnow.html">Django开发必知必会</a>&nbsp;以及本系列的&nbsp;<strong>javascript必知必会</strong>, 发现在写这些内容的同时,自己的相关 知识也有了很大的提高, 写的同时, 站的角度不只是作为一个&nbsp;<strong>自学者</strong>&nbsp;,而是作为一个&nbsp;<strong>教者</strong>&nbsp;,我希望能够看到这些 内容的读者也能够受益. 所以我想后续,我可能会写一些&nbsp;<strong>计算机科学</strong>&nbsp;的其它专题, 如:</p>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li>python必知必会</li>
    <li>正则表达式必知必会</li>
    <li>Web开发必知必会</li>
    <li>等等</li>
</ol>
<p>如果这个"宏伟"的计划得以完成, 我想也就成就我自已定义的一个&nbsp;<strong>优秀程序员</strong>&nbsp;的知识基础.</p>
<p>这是一个初步的计划, 我会逐渐展开的. 希望大家能够不断反馈.</p>
<p>谢谢.</p>
</div>
<div class="section" id="id7">
<h1><a class="toc-backref" href="#id23" style="text-decoration: none; color: black; ">参考资料</a></h1>
<ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; ">
    <li><a class="reference external" href="http://www.cnblogs.com/mindsbook/archive/2009/09/21/javascriptYouMustKnowClosure.html">javascript必知必会之closure</a></li>
    <li><a class="reference external" href="http://www.cnblogs.com/mindsbook/archive/2009/09/19/javascriptYouMustKnowPrototype.html">javascript必知必会之prototype</a></li>
    <li><a class="reference external" href="http://en.wikipedia.org/wiki/Unobtrusive_JavaScript">Unobtrusive JavaScript</a></li>
    <li><a class="reference external" href="http://www.quirksmode.org/js/this.html">The this keyword</a></li>
</ol>
</div>
<div class="section" id="id8">
<h1><a class="toc-backref" href="#id24" style="text-decoration: none; color: black; ">本文的源码</a></h1>
<p>本文的rst源码链接在&nbsp;<a class="reference external" href="http://sites.google.com/site/towerjoo/download/javascriptYouMustKnow-this.rst?attredirects=0">这里</a>&nbsp;.</p>
<p>点击&nbsp;<a class="reference external" href="http://sites.google.com/site/towerjoo/download/this.html?attredirects=0">这儿</a>&nbsp;下载文中涉及的javascript源码.</p>
</div>
</span>
