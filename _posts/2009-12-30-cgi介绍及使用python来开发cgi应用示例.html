--- 
layout: post
tags: []

type: post
meta: 
  _encloseme: "1"
published: true
title: CGI介绍及使用Python来开发CGI应用示例

status: publish
category: tech
---
<span class="Apple-style-span" style="font-family: Sans; line-height: normal; font-size: medium; "><h1 class="title" style="text-align: center; ">CGI介绍及使用Python来开发CGI应用示例</h1><p>本博客所有内容采用&nbsp;<a class="reference external" href="http://creativecommons.org/about/licenses/meet-the-licenses" target="_blank">Creative Commons Licenses</a>&nbsp;许可使用. 引用本内容时，请保留&nbsp;<a class="reference external" href="http://sites.google.com/site/towerjoo" target="_blank">朱涛</a>,&nbsp;<a class="reference external" href="http://www.cnblogs.com/mindsbook" target="_blank">出处</a>&nbsp;，并且&nbsp;<strong>非商业</strong>&nbsp;.</p><p>点击&nbsp;<a class="reference external" href="http://feed.feedsky.com/MindsbookTowerJoo" target="_blank">订阅</a>&nbsp;来订阅本博客.(推荐使用&nbsp;<a class="reference external" href="http://reader.google.com/" target="_blank">google reader</a>, 如果你的浏览器不支持直接订阅,请直接在&nbsp;<a class="reference external" href="http://reader.google.com/" target="_blank">google reader</a>&nbsp;中手动添加).</p><p>点击&nbsp;<a class="reference external" href="http://cn.drop.io/download/4b3b2737/905e96c35032613219e4ed5f86337176870d1d07/5dd2ae20-d759-012c-12b0-f09bca161cd0/626ff270-d759-012c-f75f-fa2b1a64fe04/v2/original_content" target="_blank">下载pdf阅读</a>&nbsp;(如果浏览器不支持直接打开,请点击右键另存)</p><div class="section" id="id1"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id16" style="text-decoration: none; color: black; " target="_blank">摘要</a></h1><div class="contents topic" id="contents" style="margin-top: 2em; margin-right: 2em; margin-bottom: 2em; margin-left: 2em; "><p class="topic-title first" style="margin-top: 0px !important; font-weight: bold; ">Contents</p><ul class="simple" style="margin-bottom: 1em; "><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id1" id="id16" target="_blank">摘要</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id2" id="id17" target="_blank">引入</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#cgi" id="id18" target="_blank">CGI的介绍</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id3" id="id19" target="_blank">CGI的缺点</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#pythoncgi" id="id20" target="_blank">使用Python来开发简单的CGI应用</a><ul><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id4" id="id21" target="_blank">配置环境</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#python" id="id22" target="_blank">编写python文件</a></li></ul></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id5" id="id23" target="_blank">引申</a><ul><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id6" id="id24" target="_blank">关于框架</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#cgi-fastcgi" id="id25" target="_blank">关于CGI的缺陷-Fastcgi</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#cgi-mod-xxx" id="id26" target="_blank">关于CGI的缺陷-mod_xxx</a></li></ul></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id7" id="id27" target="_blank">结论</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id8" id="id28" target="_blank">后记</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id9" id="id29" target="_blank">参考资料</a></li><li><a class="reference internal" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id10" id="id30" target="_blank">本文的源码</a></li></ul></div><p>本文主要介绍了CGI相关的一些知识, 并使用Python来开发一个CGI的应用作为示例.</p></div><div class="section" id="id2"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id17" style="text-decoration: none; color: black; " target="_blank">引入</a></h1><p>我没有经历过&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;非常火的年代,也一直没有机会了解&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;开发web应用的开发过程,直到 最近听一位室友很藐视地说&nbsp;<strong>QQ居然还在用CGI</strong>&nbsp;来开发自己的应用, 于是心生出了想了解&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;的想法, 于是经过一些学习和调研,也弄清楚了一些问题,和大家分享下.</p></div><div class="section" id="cgi"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id18" style="text-decoration: none; color: black; " target="_blank">CGI的介绍</a></h1><p>wikipedia中对&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;有比较详尽的描述, 基于自己的理解总结如下.</p><p>首先,CGI在web服务器处理请求中的角色关系如下图:</p><img alt="http://farm3.static.flickr.com/2559/4227962240_59fb040e15_o.png" src="http://farm3.static.flickr.com/2559/4227962240_59fb040e15_o.png" /><p>如上图,&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;在其中扮演的是在web服务器和特定语言解释器之间输入输出的协议的角色, 每个来自用户的请求, web服务器都会唤起特定语言解释器的命令行(例如Python),&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;会作为一种约定来将web服务器获得的请求数据(如url,post data)等,有选择地 作为命令行参数来输入到解释器的命令行中(标准输入), 解释器根据输入 构造出特定的html作为标准输出, 此时&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;又会对输出作额外的处理,如加入特定的 header(mimetype,cookie等)返回给web服务器,继而返回给用户(web服务器可能会作额外的处理).</p><p>这就是一个完整的处理流程.</p></div><div class="section" id="id3"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id19" style="text-decoration: none; color: black; " target="_blank">CGI的缺点</a></h1><p><a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;作为一种标准协议后,各种主流的web服务器都支持,如&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Apache_HTTP_Server" target="_blank">apache</a>,&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Internet_Information_Services" target="_blank">IIS</a>&nbsp;等, 那么从上面的处理流程中我们会发现其中的几个主要缺点:</p><ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; "><li>对于每个请求,都需要新创建一个解释器的进程,而进程的创建通常都是比较昂贵的(expensive)</li><li>而且,对于脚本语言,解释器还需要一定的时间来解释生成对应的html</li><li>更大机率的&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Code_injection" target="_blank">code injection</a>&nbsp;, 因为在cgi脚本中都是手动地处理html所以更容易引起代码注入(当然更多地取决于程序员本身)</li></ol></div><div class="section" id="pythoncgi"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id20" style="text-decoration: none; color: black; " target="_blank">使用Python来开发简单的CGI应用</a></h1><p>环境如下:</p><ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; "><li>Ubuntu 8.10</li><li>Apache 2.x</li><li>Python 2.5.2</li></ol><div class="section" id="id4"><h2><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id21" style="text-decoration: none; color: black; " target="_blank">配置环境</a></h2><p>编辑apache配置文件(我的是/etc/apache2/apache2.conf), 加入下面一行:</p><p><em>AddHandler cgi-script .py</em></p><p>告诉apache来使用CGI协议来解释python文件.</p></div><div class="section" id="python"><h2><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id22" style="text-decoration: none; color: black; " target="_blank">编写python文件</a></h2><p>这里是个helloworld的应用, 更复杂的可参考&nbsp;<a class="reference external" href="http://docs.python.org/library/cgi.html" target="_blank">Python CGI</a>.</p><p>代码如下(假设名为test.py):</p><div class="highlight"><pre><span style="color: #408080; font-style: italic; ">#! /usr/bin/env python</span>

<span style="color: #008000; font-weight: bold; ">print</span> <span style="color: #ba2121; ">"Content-Type: text/html"</span>     <span style="color: #408080; font-style: italic; "># HTML is following</span>
<span style="color: #008000; font-weight: bold; ">print</span>                               <span style="color: #408080; font-style: italic; "># blank line, end of headers</span>

<span style="color: #008000; font-weight: bold; ">print</span> <span style="color: #ba2121; ">"&lt;html&gt;&lt;header&gt;&lt;title&gt;Test CGI Python&lt;/title&gt;&lt;/header&gt;&lt;body&gt;Hello CGI!&lt;/body&gt;&lt;/html&gt;"</span>
</pre></div><p>需要注意的是:</p><ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; "><li>一个CGI脚本由2部分组成, 第一部分是输出header, 第二部分是输出常规的html</li><li>注意&nbsp;<em>#! /usr/bin/env python</em>&nbsp;这行代码,是说明执行本脚本所用的程序(这是shell的相关知识)</li></ol><p>那么此时可以在浏览器里看到相应的输出结果.</p></div></div><div class="section" id="id5"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id23" style="text-decoration: none; color: black; " target="_blank">引申</a></h1><div class="section" id="id6"><h2><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id24" style="text-decoration: none; color: black; " target="_blank">关于框架</a></h2><p>如果你弄清楚了上面的示例,你就能够明白&nbsp;<strong>各种web框架(django, cakephp等),都只是简化和封装了一些处理的方式,本质还是类似于CGI的处理方式</strong>, 即1)header 2)html.</p><p>想想&nbsp;<a class="reference external" href="http://djangoproject.com/" target="_blank">django</a>&nbsp;的&nbsp;<em>return HttpResponse("&lt;html&gt;&lt;header&gt;&lt;/header&gt;&lt;body&gt;Hello&lt;/body&gt;&lt;/html&gt;</em>, 和上述是完全相同的.(HttpResponse默认使用text/html)</p></div><div class="section" id="cgi-fastcgi"><h2><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id25" style="text-decoration: none; color: black; " target="_blank">关于CGI的缺陷-Fastcgi</a></h2><p>既然这些缺陷是如此明显,后续的一些web服务器的设计者或者web开发者便开始着手解决这些问题, 比较重要的有:</p><p><a class="reference external" href="http://en.wikipedia.org/wiki/FastCGI" target="_blank">fastcgi</a>&nbsp;的出现,&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/FastCGI" target="_blank">fastcgi</a>&nbsp;的处理流程如下</p><img alt="http://farm3.static.flickr.com/2522/4227256031_daef91637d_o.png" src="http://farm3.static.flickr.com/2522/4227256031_daef91637d_o.png" /><p>web服务器和解释器之间使用TCP或者socket来连接,在启动时会启动若干个(可以配置)长驻进程来提供请求的服务(减少建立和销毁进程的开销), 一个进程可以服务于多个请求(使用多线程或者事件驱动,参考&nbsp;<a class="reference external" href="http://www.fastcgi.com/devkit/doc/fcgi-spec.html" target="_blank">fastcgi spec</a>&nbsp;).</p><p>所以&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/FastCGI" target="_blank">fastcgi</a>&nbsp;很好地解决了进程建立/销毁开销的问题.</p></div><div class="section" id="cgi-mod-xxx"><h2><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id26" style="text-decoration: none; color: black; " target="_blank">关于CGI的缺陷-mod_xxx</a></h2><p>另一个思路是类似于apache的mod_perl这样的解决方式.这种方式是将处理逻辑集成在web服务器之中, 如下图:</p><img alt="http://www.apachetutor.org/dev/request-3.gif" src="http://www.apachetutor.org/dev/request-3.gif" /><p>其中你可以在Data Axis(竖轴)上,&nbsp;<em>Content Generator</em>&nbsp;之前或者之后来加入相应的filter(即module), 来进行特定的处理. 具体可以参考:&nbsp;<a class="reference external" href="http://www.apachetutor.org/dev/request" target="_blank">Request Processing in Apache</a></p><p>通常而言,集成在web服务器中的module方式,会有更好的性能优势, 但是因为是集成在web服务器中, 所以mod_xxx崩溃很有可能会使得web服务器也崩溃.而&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/FastCGI" target="_blank">fastcgi</a>&nbsp;与web服务器之间是独立的进程 一个挂了不会影响另一个.</p><p>具体的二者的细节和优劣势,我想后面再写一篇博客来阐述.</p></div></div><div class="section" id="id7"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id27" style="text-decoration: none; color: black; " target="_blank">结论</a></h1><p>最后,我们回到我的室友提到的那个问题,&nbsp;<strong>QQ居然还在用CGI</strong>&nbsp;, 通过上面的分析,我们现在应该很明确了, 使用纯的CGI并不是一个好的办法, 因为它的诸多缺陷, 所以可以使用&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/FastCGI" target="_blank">fastcgi</a>&nbsp;或者module的方式.</p><p>当然,作为最初动态网页内容处理的始祖,&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;是具有里程碑式意义的协议,到后来的&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/FastCGI" target="_blank">fastcgi</a>,&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/SCGI" target="_blank">scgi</a>&nbsp;等 都是与&nbsp;<a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface" target="_blank">CGI</a>&nbsp;的理念相同的.</p></div><div class="section" id="id8"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id28" style="text-decoration: none; color: black; " target="_blank">后记</a></h1><p>好久没更新日志了,因为最近实在很忙,不过后面还会尽量来更新的.</p><p>欢迎大家讨论留言.</p></div><div class="section" id="id9"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id29" style="text-decoration: none; color: black; " target="_blank">参考资料</a></h1><ol class="arabic simple" style="margin-bottom: 1em; list-style-type: decimal; list-style-position: initial; list-style-image: initial; "><li><a class="reference external" href="http://www.apachetutor.org/dev/request" target="_blank">Request Processing in Apache</a></li><li><a class="reference external" href="http://docs.python.org/library/cgi.html" target="_blank">Python CGI</a></li><li><a class="reference external" href="http://en.wikipedia.org/wiki/FastCGI" target="_blank">fastcgi</a></li></ol></div><div class="section" id="id10"><h1><a class="toc-backref" href="http://www.cnblogs.com/mindsbook/admin/EditPosts.aspx?postid=1636272#id30" style="text-decoration: none; color: black; " target="_blank">本文的源码</a></h1><p>本文的rst源码链接在&nbsp;<a class="reference external" href="http://cn.drop.io/download/4b3b290d/fa646d91beb02e36b908fcd5e5601e840d0e2487/5dd2ae20-d759-012c-12b0-f09bca161cd0/2197b7a0-d75a-012c-8154-f0aa1172bf44/v2/original_content" target="_blank">这里</a>&nbsp;.</p><p>点击&nbsp;<a class="reference external" href="http://cn.drop.io/download/4b3b2737/905e96c35032613219e4ed5f86337176870d1d07/5dd2ae20-d759-012c-12b0-f09bca161cd0/626ff270-d759-012c-f75f-fa2b1a64fe04/v2/original_content" target="_blank">下载pdf阅读</a>&nbsp;(如果浏览器不支持直接打开,请点击右键另存)</p></div></span>
